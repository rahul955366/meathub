server:
  port: 8000

spring:
  application:
    name: api-gateway
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOriginPatterns:
              - "http://localhost:5173"
              - "http://localhost:3000"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
              - PATCH
            allowedHeaders:
              - "*"
            exposedHeaders:
              - "*"
            allowCredentials: true
            maxAge: 3600
      routes:
        - id: auth-service
          uri: http://localhost:8081
          predicates:
            - Path=/auth/**
          # No filters needed for auth service itself (public endpoints inside it)

        # Secured Services
        - id: user-service
          uri: http://localhost:8082
          predicates:
            - Path=/users/**
          filters:
            - JwtAuthenticationFilter
            - name: CircuitBreaker
              args:
                name: userServiceBreaker
                fallbackUri: forward:/fallback/user
            - name: Retry
              args:
                retries: 3
                methods: GET,POST,PUT,DELETE
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false

        - id: butcher-service
          uri: http://localhost:8083
          predicates:
            - Path=/butchers/**
          filters:
            - JwtAuthenticationFilter
            - name: CircuitBreaker
              args:
                name: butcherServiceBreaker
                fallbackUri: forward:/fallback/butcher
            - name: Retry
              args:
                retries: 3
                methods: GET,POST,PUT,DELETE
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false

        - id: order-service
          uri: http://localhost:8084
          predicates:
            - Path=/orders/**
          filters:
            - JwtAuthenticationFilter
            - name: CircuitBreaker
              args:
                name: orderServiceBreaker
                fallbackUri: forward:/fallback/order
            - name: Retry
              args:
                retries: 3
                methods: GET,POST,PUT,DELETE
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false

        - id: order-service-cart
          uri: http://localhost:8084
          predicates:
            - Path=/cart/**
          filters:
            - JwtAuthenticationFilter
            - name: CircuitBreaker
              args:
                name: cartServiceBreaker
                fallbackUri: forward:/fallback/cart
            - name: Retry
              args:
                retries: 3
                methods: GET,POST,PUT,DELETE
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false

        - id: order-service-payments
          uri: http://localhost:8084
          predicates:
            - Path=/payments/**
          filters:
            - JwtAuthenticationFilter
            - name: CircuitBreaker
              args:
                name: paymentServiceBreaker
                fallbackUri: forward:/fallback/payment
            - name: Retry
              args:
                retries: 3
                methods: GET,POST,PUT,DELETE
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false

        - id: order-service-reviews
          uri: http://localhost:8084
          predicates:
            - Path=/reviews/**
          filters:
            - JwtAuthenticationFilter
            - name: CircuitBreaker
              args:
                name: reviewServiceBreaker
                fallbackUri: forward:/fallback/review
            - name: Retry
              args:
                retries: 3
                methods: GET,POST,PUT,DELETE
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false

        - id: subscription-service
          uri: http://localhost:8085
          predicates:
            - Path=/subscriptions/**
          filters:
            - JwtAuthenticationFilter
            - name: CircuitBreaker
              args:
                name: subscriptionServiceBreaker
                fallbackUri: forward:/fallback/subscription
            - name: Retry
              args:
                retries: 3
                methods: GET,POST,PUT,DELETE
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false

        - id: delivery-service
          uri: http://localhost:8086
          predicates:
            - Path=/deliveries/**
          filters:
            - JwtAuthenticationFilter
            - name: CircuitBreaker
              args:
                name: deliveryServiceBreaker
                fallbackUri: forward:/fallback/delivery
            - name: Retry
              args:
                retries: 3
                methods: GET,POST,PUT,DELETE
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false

        - id: gym-service
          uri: http://localhost:8087
          predicates:
            - Path=/gym/**
          filters:
            - JwtAuthenticationFilter
            - name: CircuitBreaker
              args:
                name: gymServiceBreaker
                fallbackUri: forward:/fallback/gym
            - name: Retry
              args:
                retries: 3
                methods: GET,POST,PUT,DELETE
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false

        - id: pet-service
          uri: http://localhost:8088
          predicates:
            - Path=/pet/**
          filters:
            - JwtAuthenticationFilter
            - name: CircuitBreaker
              args:
                name: petServiceBreaker
                fallbackUri: forward:/fallback/pet
            - name: Retry
              args:
                retries: 3
                methods: GET,POST,PUT,DELETE
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false

        - id: media-service
          uri: http://localhost:8089
          predicates:
            - Path=/media/**
          filters:
            - JwtAuthenticationFilter
            - name: CircuitBreaker
              args:
                name: mediaServiceBreaker
                fallbackUri: forward:/fallback/media
            - name: Retry
              args:
                retries: 3
                methods: GET,POST,PUT,DELETE
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false

        - id: admin-service
          uri: http://localhost:8090
          predicates:
            - Path=/admin/**
          filters:
            - JwtAuthenticationFilter
            - name: CircuitBreaker
              args:
                name: adminServiceBreaker
                fallbackUri: forward:/fallback/admin
            - name: Retry
              args:
                retries: 3
                methods: GET,POST,PUT,DELETE
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false

        - id: notification-service
          uri: http://localhost:8091
          predicates:
            - Path=/notifications/**
          filters:
            - JwtAuthenticationFilter
            - name: CircuitBreaker
              args:
                name: notificationServiceBreaker
                fallbackUri: forward:/fallback/notification
            - name: Retry
              args:
                retries: 3
                methods: GET,POST,PUT,DELETE
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false

        - id: ai-service
          uri: http://localhost:8092
          predicates:
            - Path=/ai/**
          filters:
            - name: CircuitBreaker
              args:
                name: aiServiceBreaker
                fallbackUri: forward:/fallback/ai
            - name: Retry
              args:
                retries: 3
                methods: GET,POST,PUT,DELETE
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false

        - id: blockchain-service
          uri: http://localhost:8093
          predicates:
            - Path=/blockchain/**
          filters:
            - JwtAuthenticationFilter
            - name: CircuitBreaker
              args:
                name: blockchainServiceBreaker
                fallbackUri: forward:/fallback/blockchain
            - name: Retry
              args:
                retries: 3
                methods: GET,POST,PUT,DELETE
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms
                  factor: 2
                  basedOnPreviousValue: false

        # WebSocket route for real-time order tracking
        - id: order-service-websocket
          uri: ws://localhost:8084
          predicates:
            - Path=/ws/orders/**
          # WebSocket connections don't use JWT filter (handled in service)

jwt:
  secret: 404E635266556A586E3272357538782F413F4428472B4B6250645367566B5970404E635266556A586E3272357538782F413F4428472B4B6250645367566B5970
  expiration: 86400000

# Resilience4j Configuration
resilience4j:
  circuitbreaker:
    configs:
      default:
        failureRateThreshold: 50
        slowCallRateThreshold: 50
        slowCallDurationThreshold: 2000ms
        permittedNumberOfCallsInHalfOpenState: 3
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 10
        waitDurationInOpenState: 10000ms
        minimumNumberOfCalls: 5
  retry:
    configs:
      default:
        maxAttempts: 3
        waitDuration: 500ms
        retryOnException:
          - java.io.IOException
          - java.util.concurrent.TimeoutException
          - org.springframework.web.client.ResourceAccessException
  timelimiter:
    configs:
      default:
        timeoutDuration: 5000ms

# Enable actuator endpoints for monitoring
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,circuitbreakers,retry,ratelimit
  endpoint:
    health:
      show-details: when_authorized
    metrics:
      enabled: true
    prometheus:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true

logging:
  level:
    org.springframework.cloud.gateway: INFO
    org.springframework.http.server.reactive: INFO
    io.github.resilience4j: DEBUG
